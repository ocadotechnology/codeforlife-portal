{% extends 'portal/base.html' %}
{% load static %}
{% load app_tags %}

{% block scripts %}
{{ block.super }}
<script type="text/javascript" src="{% static 'portal/js/organisation_manage.js' %}"></script>
<script>
    var CONFIRMATION_DATA = {};

    $(document).ready(function(){
        $("#update-details").on("click", () => {
            $("#tab-account").click()
        })

        {% if delete_account_confirm %}
            showDeleteAccountConfirmation("{{ delete_account_form.delete_password.value }}", "{{ delete_account_form.unsubscribe_newsletter.value }}", {{ user.new_teacher.has_class|yesno:"true,false" }});
        {% endif %}
})
</script>
{% endblock scripts %}

{% block subNav %}
<section class="banner banner--teacher">
    <h1 class="banner__text--primary">Welcome back, {{ user|make_into_username }}</h1>
</section>
{% endblock subNav %}

{% block content %}
{% include "portal/partials/popup.html" %}
{% include "portal/partials/delete_popup.html" %}

<div id="teach_dashboard_account_page"></div>

<div class="tab-content">
    <div id="account" class="tab-pane active">
        <div class="background container">
            <section>
                <h4>Your account</h4>
            </section>
            <p>You can update your account details below.</p>
            <form autocomplete="off" method="post" id="form-edit-teacher">

                {% csrf_token %}

                {{ update_account_form.non_field_errors }}

                <div class="row form--row">
                    <div class="form--row__input col-sm-6 col-md-4">
                        <div class="input--icon">
                            {{ update_account_form.first_name }}
                        </div>
                        <small>{{ update_account_form.first_name.help_text }}</small>
                        {{ update_account_form.first_name.errors }}
                    </div>
                    <div class="form--row__input col-sm-6 col-md-4">
                        <div class="input--icon">
                            {{ update_account_form.last_name }}
                        </div>
                        <small>{{ update_account_form.last_name.help_text }}</small>
                        {{ update_account_form.last_name.errors }}
                    </div>
                    <div class="form--row__input col-sm-6 col-md-4">
                        <div class="input--icon">
                            {{ update_account_form.email }}
                            <span class="iconify" data-icon="mdi:email-outline"></span>
                        </div>
                        <small>{{ update_account_form.email.help_text }}</small>
                        {{ update_account_form.email.errors }}
                    </div>
                </div>
                <div id="edit_account_details_password" class="row form--row">
                    <div class="form--row__input col-sm-6 col-md-4">
                        <div class="input--icon">
                            {{ update_account_form.password }}
                            <span class="iconify" data-icon="mdi:security"></span>
                        </div>
                        <small>{{ update_account_form.password.help_text }}</small>
                        {{ update_account_form.password.errors }}
                    </div>
                    <div class="form--row__input col-sm-6 col-md-4">
                        <div class="input--icon">
                            {{ update_account_form.confirm_password }}
                        </div>
                        <small>{{ update_account_form.confirm_password.help_text }}</small>
                        {{ update_account_form.confirm_password.errors }}
                    </div>
                    <div class="form--row__input col-sm-6 col-md-4">
                        <div class="input--icon">
                            {{ update_account_form.current_password }}
                            <span class="iconify" data-icon="mdi:lock-outline"></span>
                        </div>
                        <small>{{ update_account_form.current_password.help_text }}</small>
                        {{ update_account_form.current_password.errors }}
                    </div>
                </div>
                <button id="update_button" type="submit" class="button button--primary" name="update_account">Update details</button>
            </form>
        </div>

        <div class="background background--primary">
            <div class="container">
                <h5>Two factor authentication</h5>
                <p>Use your smartphone or tablet to enhance your account's security by using an authenticator app.</p>
                {% if user|has_2FA %}
                    <div class="row row--regular">
                        <div class="col-sm-6">
                            <h6>Backup tokens</h6>
                            <p>If you don't have your smartphone or tablet with you, you can access your account using backup tokens.
                                {% if backup_tokens == 1 %}
                                You have only one backup token remaining.
                                {% else %}
                                You have {{ backup_tokens }} backup tokens remaining.
                                {% endif %}
                            </p>
                            <p>View and create backup tokens for your account.</p>
                            <div class="background">
                                <a class="button button--primary"
                                href="{% url 'two_factor:backup_tokens' %}">Manage backup tokens</a>
                            </div>
                            <small class="text-danger"><strong>Note: Please make sure that you store any login details in a secure place.</strong></small>
                        </div>
                        <div class="col-sm-6">
                            <h6>Disable two factor authentication (2FA)</h6>
                            <p>We recommend you to continue using 2FA, however you can disable 2FA for your account using the button below.</p>
                            <div class="background">
                                <a class="button button--primary button--primary--danger button--icon" href="{% url 'two_factor:disable' %}">
                                    Disable 2FA<span class="iconify" data-icon="mdi:alert-circle-outline"></span></a>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="background">
                        <a class="button button--primary"
                        href="{% url 'two_factor:setup' %}">Setup two factor authentication</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <div id="delete-account" class="background">
            <div class="container">
                <h5>Delete account</h5>
                <p>If you no longer wish to have a Code for Life account, you can delete it by confirming below.
                    You will receive an email to confirm this decision.
                </p>
                <p><b>This can't be reversed. All classes you've created will be permanently erased.</b>
                </p>

                <form autocomplete="off" method="post" id="form-delete-account">

                {% csrf_token %}

                {{ delete_account_form.non_field_errors }}

                <div class="row form--row">
                    <div class="form--row__input col-sm-6 col-md-4">
                        <div class="input--icon">
                            {{ delete_account_form.delete_password }}
                            <span class="iconify" data-icon="mdi:security"></span>
                        </div>
                        <small>{{ delete_account_form.delete_password.help_text }}</small>
                        {{ delete_account_form.delete_password.errors }}
                    </div>
                    <div class="form--row__input col-sm-6 col-md-8">
                        <div class="form__checkbox">
                            <div class="form__checkbox-input">
                                {{ delete_account_form.unsubscribe_newsletter }}
                            </div>
                            <label for="id_{{ delete_account_form.unsubscribe_newsletter.html_name }}">{{ delete_account_form.unsubscribe_newsletter.label }}</label>
                        </div>
                        {{ delete_account_form.unsubscribe_newsletter.errors }}
                    </div>
                </div>
                <button id="delete_account_button" class="button button--primary button--primary--danger button--icon" name="delete_account">
                    Delete account <span class="iconify" data-icon="mdi:delete-outline"></span>
                </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock content %}
